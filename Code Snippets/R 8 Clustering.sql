-- clean up
DROP TYPE "T_DATA";
DROP TYPE "T_PARAMS";
DROP TYPE "T_RESULTS";
DROP PROCEDURE "R_CLUSTER";
DROP TABLE "DATA";
DROP TABLE "PARAMS";
DROP TABLE "RESULTS";

-- create table types
CREATE TYPE "T_DATA" AS TABLE ("ID" INTEGER, "LIFESPEND" DOUBLE, "NEWSPEND" DOUBLE, "INCOME" DOUBLE, "LOYALTY" DOUBLE);
CREATE TYPE "T_PARAMS" AS TABLE ("NAME" VARCHAR(100), "VALUE" INTEGER);
CREATE TYPE "T_RESULTS" AS TABLE ("ID" INTEGER, "CLUSTER" INTEGER);

-- create stored procedure with R script
CREATE PROCEDURE "R_CLUSTER" (IN data "T_DATA", IN params "T_PARAMS", OUT results "T_RESULTS")
LANGUAGE RLANG AS 
BEGIN
	library(cluster)
	clusters <- kmeans(data[c('LIFESPEND','NEWSPEND','INCOME','LOYALTY')], params[params$NAME=='CLUSTERS',]$VALUE)
	results <- cbind(data[c('ID')], CLUSTER=clusters$cluster)
END;

-- create tables
CREATE COLUMN TABLE "DATA" LIKE "T_DATA";
CREATE COLUMN TABLE "PARAMS" LIKE "T_PARAMS";
CREATE COLUMN TABLE "RESULTS" LIKE "T_RESULTS";

-- data
INSERT INTO "DATA" VALUES (1,7.2,3.6,6.1,2.5);
INSERT INTO "DATA" VALUES (2,5.4,3.4,1.5,0.4);
INSERT INTO "DATA" VALUES (3,6.9,3.2,5.7,2.3);
INSERT INTO "DATA" VALUES (4,5.5,2.3,4,1.3);
INSERT INTO "DATA" VALUES (5,6.1,2.9,4.7,1.4);
INSERT INTO "DATA" VALUES (6,5,3.3,1.4,0.2);
INSERT INTO "DATA" VALUES (7,5.8,2.7,5.1,1.9);
INSERT INTO "DATA" VALUES (8,5.1,3.4,1.5,0.2);
INSERT INTO "DATA" VALUES (9,6.4,3.2,5.3,2.3);
INSERT INTO "DATA" VALUES (10,5.7,2.8,4.5,1.3);
INSERT INTO "DATA" VALUES (11,6.8,3,5.5,2.1);
INSERT INTO "DATA" VALUES (12,4.3,3,1.1,0.1);
INSERT INTO "DATA" VALUES (13,7,3.2,4.7,1.4);
INSERT INTO "DATA" VALUES (14,5.4,3.4,1.7,0.2);
INSERT INTO "DATA" VALUES (15,5.4,3,4.5,1.5);
INSERT INTO "DATA" VALUES (16,5.7,2.9,4.2,1.3);
INSERT INTO "DATA" VALUES (17,6.3,2.9,5.6,1.8);
INSERT INTO "DATA" VALUES (18,5.1,3.7,1.5,0.4);
INSERT INTO "DATA" VALUES (19,6.3,2.8,5.1,1.5);
INSERT INTO "DATA" VALUES (20,5.6,2.5,3.9,1.1);
INSERT INTO "DATA" VALUES (21,5.7,2.6,3.5,1);
INSERT INTO "DATA" VALUES (22,5.4,3.9,1.3,0.4);
INSERT INTO "DATA" VALUES (23,6,3,4.8,1.8);
INSERT INTO "DATA" VALUES (24,5.5,2.6,4.4,1.2);
INSERT INTO "DATA" VALUES (25,4.7,3.2,1.3,0.2);
INSERT INTO "DATA" VALUES (26,6.8,2.8,4.8,1.4);
INSERT INTO "DATA" VALUES (27,5.9,3,4.2,1.5);
INSERT INTO "DATA" VALUES (28,5.1,3.8,1.9,0.4);
INSERT INTO "DATA" VALUES (29,5,3.5,1.3,0.3);
INSERT INTO "DATA" VALUES (30,5.8,4,1.2,0.2);
INSERT INTO "DATA" VALUES (31,7.7,2.8,6.7,2);
INSERT INTO "DATA" VALUES (32,5.2,2.7,3.9,1.4);
INSERT INTO "DATA" VALUES (33,4.4,2.9,1.4,0.2);
INSERT INTO "DATA" VALUES (34,5,3,1.6,0.2);
INSERT INTO "DATA" VALUES (35,7.6,3,6.6,2.1);
INSERT INTO "DATA" VALUES (36,5.1,3.5,1.4,0.3);
INSERT INTO "DATA" VALUES (37,6,3.4,4.5,1.6);
INSERT INTO "DATA" VALUES (38,5.7,3.8,1.7,0.3);
INSERT INTO "DATA" VALUES (39,6.2,3.4,5.4,2.3);
INSERT INTO "DATA" VALUES (40,7.3,2.9,6.3,1.8);
INSERT INTO "DATA" VALUES (41,5.7,2.5,5,2);
INSERT INTO "DATA" VALUES (42,6.7,3.1,5.6,2.4);
INSERT INTO "DATA" VALUES (43,6.1,2.8,4.7,1.2);
INSERT INTO "DATA" VALUES (44,5.7,4.4,1.5,0.4);
INSERT INTO "DATA" VALUES (45,5.6,2.7,4.2,1.3);
INSERT INTO "DATA" VALUES (46,5.5,4.2,1.4,0.2);
INSERT INTO "DATA" VALUES (47,6.3,3.4,5.6,2.4);
INSERT INTO "DATA" VALUES (48,6.7,3.1,4.7,1.5);
INSERT INTO "DATA" VALUES (49,6.3,3.3,6,2.5);
INSERT INTO "DATA" VALUES (50,6.3,2.3,4.4,1.3);

-- parameters
INSERT INTO "PARAMS" VALUES ('CLUSTERS',3);

-- call : results inline
CALL "R_CLUSTER" ("DATA", "PARAMS", ?);

-- call : results in table
TRUNCATE TABLE "RESULTS";
CALL "R_CLUSTER" ("DATA", "PARAMS", "RESULTS") WITH OVERVIEW;
SELECT * FROM "RESULTS";
